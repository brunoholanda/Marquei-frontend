import{r,e as Ce,j as e,c as u,N as Ge}from"./index-CNAW3eq3.js";import{S as ae,a as Je,b as Ke,D as B,c as Qe,d as Xe,e as Ze,f as v,g as pe,h as ea,i as aa,j as sa,k as he}from"./Styles-C_5TLpkW.js";import{M as U}from"./index-D1_O_0Vz.js";import{B as g}from"./context-dvodvhd4.js";import{D as oa}from"./index-C7ivzDJW.js";import{T as ra}from"./index-B2KaeOWd.js";import{s as k}from"./index-DM-nIBs1.js";import{m as p}from"./index-BfLTes4p.js";import{h as F}from"./moment-gy9AvL1k.js";import{R as ta}from"./index-qUsIdYuc.js";import{H as na}from"./Holidays-BSmLINqD.js";import{U as ia,P as la}from"./registerModal-ZiyjuN5m.js";import ca from"./index-B1PnSOQa.js";import{A as da}from"./AddClientsModal-BcopoWXb.js";import{C as ge}from"./index-DVU8cMF6.js";import{s as ma}from"./commonMailDomains-C8uuVB4t.js";import{F as xe}from"./index-zYDVGZq8.js";import{c as ua}from"./AntdIcon-BGp71K7u.js";import{t as fa,C as pa,o as ha}from"./useSize-zNFkUmnO.js";import{g as ga}from"./PurePanel-zdfJd6bP.js";import{i as ye}from"./render-BV6mHij8.js";import{S as L}from"./index-B1nCgeeC.js";import{I as se}from"./index-BdZwxmcX.js";import{R as Se}from"./index-0zhoecpu.js";import{C as xa}from"./index-DdOCm7yX.js";const{Option:oe}=L;function be(S){return S&&S.type&&(S.type.isSelectOption||S.type.isSelectOptGroup)}const ya=(S,Y)=>{const{prefixCls:c,className:b,popupClassName:l,dropdownClassName:$,children:h,dataSource:w}=S,j=fa(h);let N;j.length===1&&ye(j[0])&&!be(j[0])&&([N]=j);const I=N?()=>N:void 0;let C;j.length&&be(j[0])?C=h:C=w?w.map(x=>{if(ye(x))return x;switch(typeof x){case"string":return r.createElement(oe,{key:x,value:x},x);case"object":{const{value:d}=x;return r.createElement(oe,{key:d,value:d},x.text)}default:return}}):[];const{getPrefixCls:_}=r.useContext(pa),E=_("select",c);return r.createElement(L,Object.assign({ref:Y,suffixIcon:null},ha(S,["dataSource","dropdownClassName"]),{prefixCls:E,popupClassName:l||$,className:ua(`${E}-auto-complete`,b),mode:L.SECRET_COMBOBOX_MODE_DO_NOT_USE,getInputElement:I}),C)},z=r.forwardRef(ya),Sa=ga(z);z.Option=oe;z._InternalPanelDoNotUseOrYouWillBeFired=Sa;const ba=z,Ja=({isModalVisible:S,setIsModalVisible:Y,currentAppointment:c,handleClose:b})=>{const[l,$]=r.useState(null),[h,w]=r.useState(null),[j,N]=r.useState(""),[I,C]=r.useState(!1),[_,E]=r.useState(!1),{authData:x}=Ce(),d=x.companyID,H=()=>{E(!0)},D=()=>{C(!1)},R=async()=>{try{const n=await u.delete(`/agendamentos/${c.id}`);n.data&&n.data.success?(k.success({message:"Agendamento excluído com sucesso!"}),D(),b()):p.error("Erro ao excluir o agendamento.")}catch(n){console.error("Erro ao excluir o agendamento",n),p.error("Erro ao excluir o agendamento")}},W=()=>{E(null),$(null),w(null)},T=async()=>{try{const n=await u.put(`/agendamentos/${c.id}`,{status:1});n.data&&n.data.success?k.success({message:"Agendamento confirmado com sucesso!"}):k.error({message:"Erro ao confirmar o agendamento."})}catch(n){console.error("Erro ao confirmar o agendamento",n),p.error("Erro ao confirmar o agendamento")}b()},re=async()=>{try{const n=await u.put(`/agendamentos/${c.id}`,{status:2});n.data&&n.data.success?k.success({message:"Agendamento cancelado com sucesso!"}):p.error("Erro ao cancelar o agendamento.")}catch(n){console.error("Erro ao cancelar o agendamento",n),p.error("Erro ao cancelar o agendamento")}b()},V=async()=>{if(!l||!h){k.error({message:"Por favor, selecione a data e horário para reagendar."});return}try{const n=await u.put(`/agendamentos/${c.id}`,{data:l.format("DD/MM/YYYY"),horario:h.format("HH:mm")});n.data&&n.data.success?(k.success({message:"Agendamento reagendado com sucesso!"}),W()):p.error("Erro ao reagendar.")}catch(n){console.error("Erro ao reagendar",n),p.error("Erro ao reagendar")}b()},G=(n,P)=>{k[n]({message:P})};return r.useEffect(()=>{(async()=>{if(d)try{const P=await u.get(`/companies/${d}`);N(P.data.nome)}catch(P){console.error("Erro ao buscar nome do consultório:",P),G("error","Erro ao buscar nome do consultório.")}})()},[d]),e.jsxs(e.Fragment,{children:[e.jsxs(U,{title:"O que você gostaria de fazer com este agendamento?",open:S,onCancel:b,footer:[e.jsxs(ae,{children:[e.jsx(g,{className:"button-orange modal-btn",onClick:H,children:"Reagendar"},"reschedule"),e.jsx(g,{type:"primary",className:"button-green modal-btn",onClick:T,children:"Confirmar"},"submit"),e.jsx(g,{className:"button-red modal-btn",onClick:re,children:"Cancelar Agendamento"},"cancelAppointment")]})],children:[c&&e.jsx(Je,{children:e.jsxs("p",{children:[e.jsx("b",{children:"Nome:"})," ",c.nome,e.jsx("br",{}),e.jsx("b",{children:"Telefone:"})," ",c.celular,e.jsx("br",{}),e.jsx("b",{children:"Data:"})," ",c.data,e.jsx("br",{}),e.jsx("b",{children:"Horário:"})," ",c.horario,e.jsx("br",{}),e.jsx("b",{children:"Plano:"})," ",c.planodental]})}),e.jsx(Ke,{children:c&&e.jsx(g,{className:"button-whats modal-btn",onClick:()=>{const n=`Oi, sou do consultório ${j} e estou falando aqui para saber se você deseja confirmar sua consulta agendada para ${c.data} às ${c.horario}?`,P=c.celular.replace(/[^0-9]/g,"");window.open(`https://api.whatsapp.com/send?phone=+55${P}&text=${encodeURIComponent(n)}`,"_blank")},children:"Enviar WhatsApp"},"whatsapp")})]}),e.jsxs(U,{title:"Tem certeza de que deseja excluir este agendamento? 😱",open:I,onOk:R,onCancel:D,okText:"Sim",cancelText:"Não",footer:[e.jsxs(ae,{children:[e.jsx(g,{onClick:D,children:"Não"},"cancel"),e.jsx(g,{type:"primary",onClick:R,style:{backgroundColor:"red",borderColor:"red",color:"white"},children:"Sim"},"submit")]})],children:[e.jsx(B,{}),e.jsx("p",{children:"Após esta ação você não poderá recuperar os dados desse agendamento!"}),e.jsx("p",{children:"Caso seja um novo cliente, seus dados continuaram salvos no Menu Clientes."}),e.jsx(B,{})]}),e.jsxs(U,{title:"Reagendar Agendamento ⚠️",open:_,onCancel:()=>E(!1),footer:[e.jsxs(ae,{children:[e.jsx(g,{onClick:()=>E(!1),children:"Voltar"},"back"),e.jsx(g,{type:"primary",onClick:V,children:"Salvar Reagendamento"},"submit")]})],children:[e.jsx("p",{children:"Como administrador da clinica você pode reagendar para qualquer horário, portanto certifique-se de que jé não existe alguem para a data e horários selecionados !"}),e.jsx(B,{}),e.jsxs(Qe,{children:[e.jsx(oa,{format:"DD/MM/YYYY",value:l,onChange:$}),e.jsx(ra,{format:"HH:mm",value:h,onChange:w,minuteStep:15})]}),e.jsx(B,{})]})]})},{Option:je}=L,{TextArea:ja}=se,Ka=({isModalAgendaVisible:S,handleCancel:Y,start:c,end:b})=>{const[l]=xe.useForm(),[$,h]=r.useState(!1),[w,j]=r.useState([]),[N,I]=r.useState([]),[C,_]=r.useState([]),[E,x]=r.useState([]),[d,H]=r.useState(null),[D,R]=r.useState(!1),[W,T]=r.useState([]),[re,V]=r.useState(null),[G,n]=r.useState([]),[P,te]=r.useState(!1),[Ee,J]=r.useState(!1),[K,De]=r.useState(null),[Pe,Me]=r.useState(!1),{authData:O}=Ce(),M=O.companyID,ve=O.userSpecialties||[],[ne,ie]=r.useState([]),[q,we]=r.useState(null),[Q,ke]=r.useState([]),[Ca,Ie]=r.useState({}),[le,Ea]=r.useState([]),[X,He]=r.useState(null),Ae=a=>{const s=a.target.value,t=ma(s);ie(t)},Ne=a=>{l.setFieldsValue({email:a}),ie([])},_e=async a=>{if(a.length<4){T([]);return}try{if(M){const o=(await u.get("/clients-name",{params:{company_id:M}})).data.filter(i=>i.nome.toLowerCase().includes(a.toLowerCase())).map(i=>({label:i.nome,value:i.nome,data:i}));T(o)}else console.error("Company ID not found in context")}catch(s){console.error("Erro ao buscar pacientes",s),p.error("Erro ao buscar pacientes")}},Oe=(a,s)=>{var t,o,i;V(s==null?void 0:s.data),l.setFieldsValue({email:(t=s.data)==null?void 0:t.client_email,celular:(o=s.data)==null?void 0:o.celular,planodental:(i=s.data)==null?void 0:i.planodental})},ce=new na;ce.init("BR");const Fe=a=>ce.getHolidays(a.year()).some(t=>{const o=new Date(t.date);return o.getDate()===a.date()&&o.getMonth()===a.month()&&o.getFullYear()===a.year()}),de={Segunda:1,Terça:2,Quarta:3,Quinta:4,Sexta:5,Sábado:6,Domingo:0};r.useEffect(()=>{c&&l.setFieldsValue({data:F(c),horario:F(c)}),b&&l.setFieldsValue({end_time:F(b)})},[c,b,l]),r.useEffect(()=>{d&&(async()=>{try{let s={professional_id:d};Q.length>0&&q&&(s.endereco_id=q);const t=await u.get("/dias-semanais",{params:s});j(t.data)}catch(s){console.error("Erro ao buscar dias da semana",s)}})()},[d,q,Q.length]);const Ye=()=>{Ge("/upgrade"),J(!1)},me=()=>{J(!1)},$e=a=>{const s=a.day(),t=w.find(o=>de[o.dia]===s);return!t||!t.ativo?!0:Fe(a)},Z=(a,s)=>{if(!a||D)return[];const t=a.day(),o=w.find(y=>de[y.dia]===t),i=[];if(!o||!o.ativo)return[...Array(24).keys()];const m=o.startam?parseInt(o.startam.split(":")[0],10):0,f=o.endam?parseInt(o.endam.split(":")[0],10):11,A=o.startpm?parseInt(o.startpm.split(":")[0],10):12,We=o.endpm?parseInt(o.endpm.split(":")[0],10):23;for(let y=0;y<24;y++)(y<m||y>=f&&y<A||y>We)&&i.push(y);return s.forEach(y=>{i.includes(y)||i.push(y)}),i},Re=async a=>{const s=a.format("DD/MM/YYYY");if(d&&!D)try{const o=(await u.get("/agendamentos",{params:{data:s,professional_id:d}})).data.map(i=>F(i.horario,"HH:mm").hour());_(o)}catch(t){console.error("Erro ao buscar horários agendados",t),p.error("Erro ao buscar horários agendados")}I(Z(a,C))};r.useEffect(()=>{l.getFieldValue("data")&&I(Z(l.getFieldValue("data"),C))},[D,C,l]),r.useEffect(()=>{d&&(async()=>{try{const t=(await u.get(`/enderecos/professional/${d}`)).data||[];if(ke(t),t.length===1){const o=t[0].id,i=le.reduce((m,f)=>(m[f.id]=o,m),{});Ie(i)}}catch(s){console.error("Erro ao carregar endereços:",s),p.error("Erro ao carregar endereços.")}})()},[d,le]);const Te=async a=>{h(!0);try{const s={nome:a.nome,client_email:a.email,celular:a.celular.replace(/\D/g,""),planodental:a.planodental,company_id:M},t=a.data.format("DD/MM/YYYY"),o=a.horario.format("HH:mm"),i=a.end_time.format("HH:mm"),m={...a,data:t,horario:o,end_time:i,professional_id:d,company_id:M};let f=await u.get(`/clients/email/${s.client_email}?company_id=${s.company_id}`).catch(A=>A.response);if(f&&f.status===404&&(f=await u.post("/clients",s)),f&&f.data&&f.data.id){m.client_id=f.data.id;const A=await u.post("/agendamentos",m);A.data&&A.data.error?p.error(A.data.error):(k.success({message:"Agendamento feito com sucesso!"}),l.resetFields(),ee())}else throw console.error("Erro na resposta do cliente:",f),new Error(f.data.message||"Erro ao criar ou recuperar o cliente.")}catch(s){console.error("Erro no processo de agendamento:",s),p.error(s.message||"Erro ao enviar o agendamento")}finally{h(!1)}},[Ve,ue]=r.useState([]);r.useEffect(()=>{(async()=>{if(!d){ue([]);return}try{const t=(await u.get(`/disabledDates?professional_id=${d}`)).data.map(o=>({date:F(o.date,"DD/MM/YYYY"),allDay:o.allday,startTime:o.starttime,endTime:o.endtime}));ue(t)}catch(s){console.error("Erro ao buscar datas desabilitadas",s)}})()},[d]);const qe=a=>{if(D)return!1;const s=Ve.find(t=>a.isSame(t.date,"day"));return a&&(a<F().startOf("day")||$e(a)||s&&s.allDay)},ee=()=>{l.resetFields(["data","horario","nome","email","celular","planodental","motivo","end_time"]),R(!1),I([]),_([]),H(null),T([]),V(null),Y()};r.useEffect(()=>{(async()=>{try{h(!0);const s=await u.get(`/professionals?company_id=${M}`);if(s.status!==200)throw new Error("Falha ao buscar dados dos profissionais");const o=ge.AES.decrypt(s.data,"%A0533266q6td9g*"),i=JSON.parse(o.toString(ge.enc.Utf8));if(x(i),i.length===1){const m=i[0].id;H(m);const f=await fe(m);n(f),l.setFieldsValue({professional:m,planodental:""})}}catch(s){console.error("Error fetching professionals:",s),p.error("Erro ao buscar dados dos profissionais")}finally{h(!1)}})()},[M]);const fe=async a=>{try{const s=await u.get(`/professionals/${a}/planos`);if(s.status===200)return s.data;throw new Error("Falha ao buscar planos de saúde do profissional")}catch(s){return console.error("Erro ao buscar planos de saúde",s),p.error("Erro ao buscar planos de saúde"),[]}},Be=()=>{if(E.length>=K){J(!0);return}H(null),te(!0)},Ue=()=>{te(!1),H(null)};r.useEffect(()=>{(async()=>{if(M&&O.authToken){h(!0);try{const t=(await u.get(`/companies/${M}`,{headers:{Authorization:`Bearer ${O.authToken}`}})).data.service_id,o=await u.get(`/service_details/${t}`,{headers:{Authorization:`Bearer ${O.authToken}`}});De(o.data.persons)}catch(s){console.error("Erro ao buscar o número máximo de profissionais:",s),p.error("Erro ao buscar informações do serviço")}finally{h(!1)}}})()},[M,O.authToken]);const Le=()=>{ee(),Y()},ze=a=>{we(a.target.value)};return e.jsxs(Xe,{title:"Agendar Consulta Para Paciente 👩‍⚕️",open:S,onCancel:Le,footer:[e.jsx(g,{onClick:ee,children:"Cancelar"},"back"),e.jsx(g,{type:"primary",onClick:()=>l.submit(),children:"Agendar"},"submit")],style:{top:"5%"},children:[e.jsxs(xe,{form:l,name:"agendamento",layout:"vertical",onFinish:Te,children:[e.jsx(Ze,{children:e.jsx(v,{name:"nome",rules:[{required:!0,message:"Por favor, insira o nome do paciente!"}],children:e.jsx(ba,{placeholder:"🔍 Nome do paciente",onSearch:_e,onSelect:Oe,options:W,style:{width:"100%"}})})}),e.jsx(v,{name:"email",label:"E-mail",rules:[{required:!0,message:"Por favor, insira seu e-mail!"},{type:"email",message:"Por favor, insira um e-mail válido!"}],children:e.jsx(se,{placeholder:"Seu e-mail",onChange:Ae})}),ne.length>0&&e.jsx("div",{style:{marginTop:"0.5rem",background:"#f7f7f7",padding:"0.5rem"},children:ne.map((a,s)=>e.jsx("div",{onClick:()=>Ne(a),style:{cursor:"pointer",padding:"0.5rem"},children:a},s))}),e.jsx(pe,{showSearch:!0,style:{width:200,marginBottom:20},placeholder:"Selecione um profissional",optionFilterProp:"children",onChange:async a=>{if(a){H(a);const s=await fe(a);n(s),l.setFieldsValue({planodental:""})}},filterOption:(a,s)=>s.children.toLowerCase().indexOf(a.toLowerCase())>=0,value:d,children:E.map(a=>e.jsx(je,{value:a.id,children:a.nome},a.id))}),e.jsxs(g,{style:{margin:"0 10px 10px 10px"},type:"primary",onClick:Be,children:[e.jsx(ia,{}),"Adicionar Profissional"]}),e.jsx("div",{style:{margin:"10px 0"},children:e.jsx(Se.Group,{onChange:ze,value:q,children:Q.map(a=>e.jsx(Se,{value:a.id,children:`${a.rua}, ${a.numero} - ${a.cidade}/${a.uf}`},a.id))})}),e.jsx(la,{isVisible:P,onClose:Ue,initialData:d,userSpecialties:ve}),e.jsx(v,{name:"ignoreDisabledHours",valuePropName:"checked",children:e.jsx(xa,{onChange:a=>R(a.target.checked),children:"Ignorar Horários Desabilitados e ja Agendados"})}),e.jsx(ea,{children:e.jsx(v,{name:"data",label:"Data",rules:[{required:!0,message:"Por favor, selecione uma data!"}],children:e.jsx(aa,{format:"DD/MM/YYYY",disabledDate:qe,onChange:Re},D?"ignore":"normal")})}),e.jsxs(sa,{children:[e.jsx(v,{name:"horario",label:"Horário de Início",rules:[{required:!0,message:"Por favor, selecione um horário!"}],children:e.jsx(he,{format:"HH:mm",minuteStep:5,onChange:a=>He(a),disabledTime:()=>({disabledHours:()=>Z(l.getFieldValue("data"),C)})})}),e.jsx(v,{name:"end_time",label:"Horário Final",rules:[{required:!0,message:"Por favor, selecione o horário final!"}],children:e.jsx(he,{format:"HH:mm",minuteStep:5,disabledTime:()=>{var t;const a=[],s=[];if(X){const o=X.hour(),i=X.minute();for(let m=0;m<o;m++)a.push(m);if(((t=l.getFieldValue("horario"))==null?void 0:t.hour())===o)for(let m=0;m<=i;m++)s.push(m)}return{disabledHours:()=>a,disabledMinutes:()=>s}}})})]}),e.jsx(v,{name:"planodental",rules:[{required:!0,message:"Por favor, selecione uma forma de pagamento!"}],children:e.jsx(pe,{placeholder:"Forma de pagamento",children:G.map(a=>e.jsx(je,{value:a.nome,children:a.nome},a.id))})}),e.jsx(v,{name:"celular",label:"Celular",rules:[{required:!0,message:"Por favor, insira seu número de celular!"}],children:e.jsx(ta,{mask:"(99) 9 9999-9999",placeholder:"(99) 9 9999-9999",children:a=>e.jsx(se,{...a,type:"tel"})})}),e.jsx(v,{name:"motivo",label:"Motivo da Consulta",rules:[{required:!0,message:"Por favor, descreva o motivo da consulta!"}],children:e.jsx(ja,{placeholder:"Descreva o motivo da consulta em poucas palavras",rows:2,maxLength:90})})]}),e.jsxs(U,{title:"Limite de Profissionais Atingido",open:Ee,onCancel:me,footer:[e.jsx(g,{onClick:me,children:"Cancelar"},"back"),e.jsx(g,{type:"primary",onClick:Ye,children:"Fazer Upgrade"},"submit")],children:[e.jsxs("p",{children:["Seu plano contratado só permite até ",K," profissionais. Caso sua clínica esteja crescendo, faça um upgrade do seu plano."]}),e.jsx(ca,{maxProfessionals:K})]}),e.jsx(da,{isModalAddClientsVisible:Pe,onCloseAddClients:()=>Me(!1)})]})};export{Ja as A,Ka as S};
