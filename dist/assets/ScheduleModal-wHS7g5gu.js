import{r,d as xe,j as e,N as Te}from"./index-BjWOWftK.js";import{a as p}from"./api-yj2qoLPl.js";import{S as X,a as Ve,b as Re,D as q,c as $e,d as qe,e as Be,f as w,g as de,h as Ue,i as Le,j as ze,k as me}from"./Styles-HDwQP3Lk.js";import{M as B}from"./index-DZhypcJC.js";import{B as g}from"./context-CsxF_MV5.js";import{D as We}from"./index-C7SteZcr.js";import{T as Ge}from"./index-DmbuE59p.js";import{s as v}from"./index-DmCwQh6m.js";import{m as f}from"./index-voIPXOLj.js";import{h as N}from"./moment-gy9AvL1k.js";import{R as Je}from"./index-SZJkRHiF.js";import{H as Ke}from"./Holidays-cu-aYy69.js";import{U as Qe,P as Xe}from"./registerModal-CPwCNS73.js";import Ze from"./index-DncJ83qH.js";import{A as ea}from"./AddClientsModal-Db1tA1OF.js";import{C as ue}from"./index-CQC3ljG7.js";import{s as aa}from"./commonMailDomains-C8uuVB4t.js";import{F as pe}from"./index-DWnRouz4.js";import{c as oa}from"./AntdIcon-CQBeZWiu.js";import{t as sa,C as ra,o as ta}from"./useSize-xGuuOV2H.js";import{g as na}from"./PurePanel-vSTbxOUV.js";import{i as fe}from"./render-Dc9fgLFB.js";import{S as U}from"./index-CrIh86xN.js";import{I as Z}from"./index-Dtquuxsa.js";import{C as ia}from"./index-DICP50cq.js";const{Option:ee}=U;function he(b){return b&&b.type&&(b.type.isSelectOption||b.type.isSelectOptGroup)}const la=(b,Y)=>{const{prefixCls:c,className:j,popupClassName:l,dropdownClassName:T,children:h,dataSource:k}=b,S=sa(h);let _;S.length===1&&fe(S[0])&&!he(S[0])&&([_]=S);const H=_?()=>_:void 0;let C;S.length&&he(S[0])?C=h:C=k?k.map(x=>{if(fe(x))return x;switch(typeof x){case"string":return r.createElement(ee,{key:x,value:x},x);case"object":{const{value:d}=x;return r.createElement(ee,{key:d,value:d},x.text)}default:return}}):[];const{getPrefixCls:F}=r.useContext(ra),D=F("select",c);return r.createElement(U,Object.assign({ref:Y,suffixIcon:null},ta(b,["dataSource","dropdownClassName"]),{prefixCls:D,popupClassName:l||T,className:oa(`${D}-auto-complete`,j),mode:U.SECRET_COMBOBOX_MODE_DO_NOT_USE,getInputElement:H}),C)},L=r.forwardRef(la),ca=na(L);L.Option=ee;L._InternalPanelDoNotUseOrYouWillBeFired=ca;const da=L,Ya=({isModalVisible:b,setIsModalVisible:Y,currentAppointment:c,handleClose:j})=>{const[l,T]=r.useState(null),[h,k]=r.useState(null),[S,_]=r.useState(""),[H,C]=r.useState(!1),[F,D]=r.useState(!1),{authData:x}=xe(),d=x.companyID,I=()=>{D(!0)},E=()=>{C(!1)},V=async()=>{try{const t=await p.delete(`/agendamentos/${c.id}`);t.data&&t.data.success?(v.success({message:"Agendamento excluído com sucesso!"}),E(),j()):f.error("Erro ao excluir o agendamento.")}catch(t){console.error("Erro ao excluir o agendamento",t),f.error("Erro ao excluir o agendamento")}},z=()=>{D(null),T(null),k(null)},R=async()=>{try{const t=await p.put(`/agendamentos/${c.id}`,{status:1});t.data&&t.data.success?v.success({message:"Agendamento confirmado com sucesso!"}):v.error({message:"Erro ao confirmar o agendamento."})}catch(t){console.error("Erro ao confirmar o agendamento",t),f.error("Erro ao confirmar o agendamento")}j()},ae=async()=>{try{const t=await p.put(`/agendamentos/${c.id}`,{status:2});t.data&&t.data.success?v.success({message:"Agendamento cancelado com sucesso!"}):f.error("Erro ao cancelar o agendamento.")}catch(t){console.error("Erro ao cancelar o agendamento",t),f.error("Erro ao cancelar o agendamento")}j()},$=async()=>{if(!l||!h){v.error({message:"Por favor, selecione a data e horário para reagendar."});return}try{const t=await p.put(`/agendamentos/${c.id}`,{data:l.format("DD/MM/YYYY"),horario:h.format("HH:mm")});t.data&&t.data.success?(v.success({message:"Agendamento reagendado com sucesso!"}),z()):f.error("Erro ao reagendar.")}catch(t){console.error("Erro ao reagendar",t),f.error("Erro ao reagendar")}j()},W=(t,P)=>{v[t]({message:P})};return r.useEffect(()=>{(async()=>{if(d)try{const P=await p.get(`/companies/${d}`);_(P.data.nome)}catch(P){console.error("Erro ao buscar nome do consultório:",P),W("error","Erro ao buscar nome do consultório.")}})()},[d]),e.jsxs(e.Fragment,{children:[e.jsxs(B,{title:"O que você gostaria de fazer com este agendamento?",open:b,onCancel:j,footer:[e.jsxs(X,{children:[e.jsx(g,{className:"button-orange modal-btn",onClick:I,children:"Reagendar"},"reschedule"),e.jsx(g,{type:"primary",className:"button-green modal-btn",onClick:R,children:"Confirmar"},"submit"),e.jsx(g,{className:"button-red modal-btn",onClick:ae,children:"Cancelar Agendamento"},"cancelAppointment")]})],children:[c&&e.jsx(Ve,{children:e.jsxs("p",{children:[e.jsx("b",{children:"Nome:"})," ",c.nome,e.jsx("br",{}),e.jsx("b",{children:"Telefone:"})," ",c.celular,e.jsx("br",{}),e.jsx("b",{children:"Data:"})," ",c.data,e.jsx("br",{}),e.jsx("b",{children:"Horário:"})," ",c.horario,e.jsx("br",{}),e.jsx("b",{children:"Plano:"})," ",c.planodental]})}),e.jsx(Re,{children:c&&e.jsx(g,{className:"button-whats modal-btn",onClick:()=>{const t=`Oi, sou do consultório ${S} e estou falando aqui para saber se você deseja confirmar sua consulta agendada para ${c.data} às ${c.horario}?`,P=c.celular.replace(/[^0-9]/g,"");window.open(`https://api.whatsapp.com/send?phone=+55${P}&text=${encodeURIComponent(t)}`,"_blank")},children:"Enviar WhatsApp"},"whatsapp")})]}),e.jsxs(B,{title:"Tem certeza de que deseja excluir este agendamento? 😱",open:H,onOk:V,onCancel:E,okText:"Sim",cancelText:"Não",footer:[e.jsxs(X,{children:[e.jsx(g,{onClick:E,children:"Não"},"cancel"),e.jsx(g,{type:"primary",onClick:V,style:{backgroundColor:"red",borderColor:"red",color:"white"},children:"Sim"},"submit")]})],children:[e.jsx(q,{}),e.jsx("p",{children:"Após esta ação você não poderá recuperar os dados desse agendamento!"}),e.jsx("p",{children:"Caso seja um novo cliente, seus dados continuaram salvos no Menu Clientes."}),e.jsx(q,{})]}),e.jsxs(B,{title:"Reagendar Agendamento ⚠️",open:F,onCancel:()=>D(!1),footer:[e.jsxs(X,{children:[e.jsx(g,{onClick:()=>D(!1),children:"Voltar"},"back"),e.jsx(g,{type:"primary",onClick:$,children:"Salvar Reagendamento"},"submit")]})],children:[e.jsx("p",{children:"Como administrador da clinica você pode reagendar para qualquer horário, portanto certifique-se de que jé não existe alguem para a data e horários selecionados !"}),e.jsx(q,{}),e.jsxs($e,{children:[e.jsx(We,{format:"DD/MM/YYYY",value:l,onChange:T}),e.jsx(Ge,{format:"HH:mm",value:h,onChange:k,minuteStep:15})]}),e.jsx(q,{})]})]})},{Option:ge}=U,{TextArea:ma}=Z,Ta=({isModalAgendaVisible:b,handleCancel:Y,start:c,end:j})=>{const[l]=pe.useForm(),[T,h]=r.useState(!1),[k,S]=r.useState([]),[_,H]=r.useState([]),[C,F]=r.useState([]),[D,x]=r.useState([]),[d,I]=r.useState(null),[E,V]=r.useState(!1),[z,R]=r.useState([]),[ae,$]=r.useState(null),[W,t]=r.useState([]),[P,oe]=r.useState(!1),[ye,G]=r.useState(!1),[J,be]=r.useState(null),[je,Se]=r.useState(!1),{authData:O}=xe(),M=O.companyID,Ce=O.userSpecialties||[],[se,re]=r.useState([]),De=a=>{const o=a.target.value,i=aa(o);re(i)},Ee=a=>{l.setFieldsValue({email:a}),re([])},Pe=async a=>{if(a.length<4){R([]);return}try{if(M){const s=(await p.get("/clients",{params:{company_id:M}})).data.filter(n=>n.nome.toLowerCase().includes(a.toLowerCase())).map(n=>({label:n.nome,value:n.nome,data:n}));R(s)}else console.error("Company ID not found in context")}catch(o){console.error("Erro ao buscar pacientes",o),f.error("Erro ao buscar pacientes")}},Me=(a,o)=>{var i,s,n;$(o==null?void 0:o.data),l.setFieldsValue({email:(i=o.data)==null?void 0:i.client_email,celular:(s=o.data)==null?void 0:s.celular,planodental:(n=o.data)==null?void 0:n.planodental})},te=new Ke;te.init("BR");const we=a=>te.getHolidays(a.year()).some(i=>{const s=new Date(i.date);return s.getDate()===a.date()&&s.getMonth()===a.month()&&s.getFullYear()===a.year()}),ne={Segunda:1,Terça:2,Quarta:3,Quinta:4,Sexta:5,Sábado:6,Domingo:0};r.useEffect(()=>{c&&l.setFieldsValue({data:N(c),horario:N(c)}),j&&l.setFieldsValue({end_time:N(j)})},[c,j,l]),r.useEffect(()=>{d&&(async()=>{try{const o=await p.get(`/dias-semanais?professional_id=${d}`);S(o.data)}catch(o){console.error("Erro ao buscar dias da semana",o)}})()},[d]);const ke=()=>{Te("/upgrade"),G(!1)},ie=()=>{G(!1)},ve=a=>{const o=a.day(),i=k.find(s=>ne[s.dia]===o);return!i||!i.ativo?!0:we(a)},K=(a,o)=>{if(!a||E)return[];const i=a.day(),s=k.find(y=>ne[y.dia]===i),n=[];if(!s||!s.ativo)return[...Array(24).keys()];const u=s.startam?parseInt(s.startam.split(":")[0],10):0,m=s.endam?parseInt(s.endam.split(":")[0],10):11,A=s.startpm?parseInt(s.startpm.split(":")[0],10):12,Ye=s.endpm?parseInt(s.endpm.split(":")[0],10):23;for(let y=0;y<24;y++)(y<u||y>=m&&y<A||y>Ye)&&n.push(y);return o.forEach(y=>{n.includes(y)||n.push(y)}),n},He=async a=>{const o=a.format("DD/MM/YYYY");if(d&&!E)try{const s=(await p.get("/agendamentos",{params:{data:o,professional_id:d}})).data.map(n=>N(n.horario,"HH:mm").hour());F(s)}catch(i){console.error("Erro ao buscar horários agendados",i),f.error("Erro ao buscar horários agendados")}H(K(a,C))};r.useEffect(()=>{l.getFieldValue("data")&&H(K(l.getFieldValue("data"),C))},[E,C,l]);const Ie=async a=>{h(!0);try{const o={nome:a.nome,client_email:a.email,celular:a.celular.replace(/\D/g,""),planodental:a.planodental,company_id:M},i=a.data.format("DD/MM/YYYY"),s=a.horario.format("HH:mm"),n=a.end_time.format("HH:mm"),u={...a,data:i,horario:s,end_time:n,professional_id:d,company_id:M};let m=await p.get(`/clients/email/${o.client_email}?company_id=${o.company_id}`).catch(A=>A.response);if(m&&m.status===404&&(m=await p.post("/clients",o)),m&&m.data&&m.data.id){u.client_id=m.data.id;const A=await p.post("/agendamentos",u);A.data&&A.data.error?f.error(A.data.error):(v.success({message:"Agendamento feito com sucesso!"}),l.resetFields(),Q())}else throw console.error("Erro na resposta do cliente:",m),new Error(m.data.message||"Erro ao criar ou recuperar o cliente.")}catch(o){console.error("Erro no processo de agendamento:",o),f.error(o.message||"Erro ao enviar o agendamento")}finally{h(!1)}},[Ae,le]=r.useState([]);r.useEffect(()=>{(async()=>{if(!d){le([]);return}try{const i=(await p.get(`/disabledDates?professional_id=${d}`)).data.map(s=>({date:N(s.date,"DD/MM/YYYY"),allDay:s.allday,startTime:s.starttime,endTime:s.endtime}));le(i)}catch(o){console.error("Erro ao buscar datas desabilitadas",o)}})()},[d]);const Ne=a=>{if(E)return!1;const o=Ae.find(i=>a.isSame(i.date,"day"));return a&&(a<N().startOf("day")||ve(a)||o&&o.allDay)},Q=()=>{l.resetFields(["data","horario","nome","email","celular","planodental","motivo","end_time"]),V(!1),H([]),F([]),I(null),R([]),$(null),Y()};r.useEffect(()=>{(async()=>{try{h(!0);const o=await p.get(`/professionals?company_id=${M}`);if(o.status!==200)throw new Error("Falha ao buscar dados dos profissionais");const s=ue.AES.decrypt(o.data,"%A0533266q6td9g*"),n=JSON.parse(s.toString(ue.enc.Utf8));if(x(n),n.length===1){const u=n[0].id;I(u);const m=await ce(u);t(m),l.setFieldsValue({professional:u,planodental:""})}}catch(o){console.error("Error fetching professionals:",o),f.error("Erro ao buscar dados dos profissionais")}finally{h(!1)}})()},[M]);const ce=async a=>{try{const o=await p.get(`/professionals/${a}/planos`);if(o.status===200)return o.data;throw new Error("Falha ao buscar planos de saúde do profissional")}catch(o){return console.error("Erro ao buscar planos de saúde",o),f.error("Erro ao buscar planos de saúde"),[]}},_e=()=>{if(D.length>=J){G(!0);return}I(null),oe(!0)},Fe=()=>{oe(!1),I(null)};r.useEffect(()=>{(async()=>{if(M&&O.authToken){h(!0);try{const i=(await p.get(`/companies/${M}`,{headers:{Authorization:`Bearer ${O.authToken}`}})).data.service_id,s=await p.get(`/service_details/${i}`,{headers:{Authorization:`Bearer ${O.authToken}`}});be(s.data.persons)}catch(o){console.error("Erro ao buscar o número máximo de profissionais:",o),f.error("Erro ao buscar informações do serviço")}finally{h(!1)}}})()},[M,O.authToken]);const Oe=()=>{Q(),Y()};return e.jsxs(qe,{title:"Agendar Consulta Para Paciente 👩‍⚕️",open:b,onCancel:Oe,footer:[e.jsx(g,{onClick:Q,children:"Cancelar"},"back"),e.jsx(g,{type:"primary",onClick:()=>l.submit(),children:"Agendar"},"submit")],style:{top:"5%"},children:[e.jsxs(pe,{form:l,name:"agendamento",layout:"vertical",onFinish:Ie,children:[e.jsx(Be,{children:e.jsx(w,{name:"nome",rules:[{required:!0,message:"Por favor, insira o nome do paciente!"}],children:e.jsx(da,{placeholder:"🔍 Nome do paciente",onSearch:Pe,onSelect:Me,options:z,style:{width:"100%"}})})}),e.jsx(w,{name:"email",label:"E-mail",rules:[{required:!0,message:"Por favor, insira seu e-mail!"},{type:"email",message:"Por favor, insira um e-mail válido!"}],children:e.jsx(Z,{placeholder:"Seu e-mail",onChange:De})}),se.length>0&&e.jsx("div",{style:{marginTop:"0.5rem",background:"#f7f7f7",padding:"0.5rem"},children:se.map((a,o)=>e.jsx("div",{onClick:()=>Ee(a),style:{cursor:"pointer",padding:"0.5rem"},children:a},o))}),e.jsx(de,{showSearch:!0,style:{width:200,marginBottom:20},placeholder:"Selecione um profissional",optionFilterProp:"children",onChange:async a=>{if(a){I(a);const o=await ce(a);t(o),l.setFieldsValue({planodental:""})}},filterOption:(a,o)=>o.children.toLowerCase().indexOf(a.toLowerCase())>=0,value:d,children:D.map(a=>e.jsx(ge,{value:a.id,children:a.nome},a.id))}),e.jsxs(g,{style:{margin:"0 10px 10px 10px"},type:"primary",onClick:_e,children:[e.jsx(Qe,{}),"Adicionar Profissional"]}),e.jsx(Xe,{isVisible:P,onClose:Fe,initialData:d,userSpecialties:Ce}),e.jsx(w,{name:"ignoreDisabledHours",valuePropName:"checked",children:e.jsx(ia,{onChange:a=>V(a.target.checked),children:"Ignorar Horários Desabilitados e ja Agendados"})}),e.jsx(Ue,{children:e.jsx(w,{name:"data",label:"Data",rules:[{required:!0,message:"Por favor, selecione uma data!"}],children:e.jsx(Le,{format:"DD/MM/YYYY",disabledDate:Ne,onChange:He},E?"ignore":"normal")})}),e.jsxs(ze,{children:[e.jsx(w,{name:"horario",label:"Horário de Início",rules:[{required:!0,message:"Por favor, selecione um horário!"}],children:e.jsx(me,{format:"HH:mm",minuteStep:5,disabledTime:()=>({disabledHours:()=>K(l.getFieldValue("data"),C)})})}),e.jsx(w,{name:"end_time",label:"Horário Final",rules:[{required:!0,message:"Por favor, selecione o horário final!"}],children:e.jsx(me,{format:"HH:mm",minuteStep:5,disabledTime:()=>{const a=l.getFieldValue("horario"),o=a?N(a,"HH:mm"):null;return{disabledHours:()=>{const n=[];for(let u=0;u<24;u++)o&&u<o.hour()&&n.push(u);return n},disabledMinutes:n=>{const u=[];if(o&&n===o.hour())for(let m=0;m<=o.minute();m++)u.push(m);return u}}}})})]}),e.jsx(w,{name:"planodental",rules:[{required:!0,message:"Por favor, selecione uma forma de pagamento!"}],children:e.jsx(de,{placeholder:"Forma de pagamento",children:W.map(a=>e.jsx(ge,{value:a.nome,children:a.nome},a.id))})}),e.jsx(w,{name:"celular",label:"Celular",rules:[{required:!0,message:"Por favor, insira seu número de celular!"}],children:e.jsx(Je,{mask:"(99) 9 9999-9999",placeholder:"(99) 9 9999-9999",children:a=>e.jsx(Z,{...a,type:"tel"})})}),e.jsx(w,{name:"motivo",label:"Motivo da Consulta",rules:[{required:!0,message:"Por favor, descreva o motivo da consulta!"}],children:e.jsx(ma,{placeholder:"Descreva o motivo da consulta em poucas palavras",rows:2,maxLength:90})})]}),e.jsxs(B,{title:"Limite de Profissionais Atingido",open:ye,onCancel:ie,footer:[e.jsx(g,{onClick:ie,children:"Cancelar"},"back"),e.jsx(g,{type:"primary",onClick:ke,children:"Fazer Upgrade"},"submit")],children:[e.jsxs("p",{children:["Seu plano contratado só permite até ",J," profissionais. Caso sua clínica esteja crescendo, faça um upgrade do seu plano."]}),e.jsx(Ze,{maxProfessionals:J})]}),e.jsx(ea,{isModalAddClientsVisible:je,onCloseAddClients:()=>Se(!1)})]})};export{Ya as A,Ta as S};
